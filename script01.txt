-- MEDIAAVALIACAO, QTD_REVIEWS_ATE_HOJE, Qtde ou % notas = [0,1,2,3,4,5]
SELECT A.idPedido, 
       AVG(B.vlNota) as MEDIA_AVALIACAO, 
       COUNT(B.vlNota) as QTD_REVIEWS_ATE_HOJE,
       COUNT(CASE WHEN B.vlNota IS NULL THEN 1 END) AS SEM_NOTA,
       COUNT(CASE WHEN B.vlNota = 0 THEN 1 END) AS QTD_NOTA_0,
       COUNT(CASE WHEN B.vlNota = 1 THEN 1 END) AS QTD_NOTA_1,
       COUNT(CASE WHEN B.vlNota = 2 THEN 1 END) AS QTD_NOTA_2,
       COUNT(CASE WHEN B.vlNota = 3 THEN 1 END) AS QTD_NOTA_3,
       COUNT(CASE WHEN B.vlNota = 4 THEN 1 END) AS QTD_NOTA_4,
       COUNT(CASE WHEN B.vlNota = 5 THEN 1 END) AS QTD_NOTA_5
FROM SILVER.OLIST.pedido A
LEFT JOIN SILVER.OLIST.avaliacao_pedido B ON B.idPedido = A.idPedido
GROUP BY A.idPedido
